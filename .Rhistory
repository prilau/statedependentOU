x = factor(Pos, level = level_order),
fill = pos_group)) +
geom_boxplot() +
ylab("Batting average") +
xlab("Position") +
ggtitle("Batting average by position") +
scale_fill_manual(values=group.colors) +
theme(axis.text = element_text(size = 10),
legend.position = "none",
plot.title = element_text(hjust = 0.5)) +
inset_element(pic,
left = 0.8,
bottom = 0.6,
right = 1,
top = 1)
library(ggarrange)
mod.1c <- lm(AVG ~ avg_hit_angle + anglesweetspotpercent + avg_hit_speed, trim)
mod.1b <- lm(AVG ~ avg_hit_angle + anglesweetspotpercent , trim)
mod.1a <- lm(AVG ~ avg_hit_angle, trim)
anova(mod.1a, mod.1b, mod.1c)
mod.2c <- lm(AVG ~ avg_hit_speed + avg_hit_angle + anglesweetspotpercent, trim)
mod.2b <- lm(AVG ~ avg_hit_speed + avg_hit_angle , trim)
mod.2a <- lm(AVG ~ avg_hit_speed, trim)
anova(mod.2a, mod.2b, mod.2c)
mod.3c <- lm(AVG ~ anglesweetspotpercent + avg_hit_speed + avg_hit_angle, trim)
mod.3b <- lm(AVG ~ anglesweetspotpercent + avg_hit_speed , trim)
mod.3a <- lm(AVG ~ anglesweetspotpercent, trim)
anova(mod.3a, mod.3b, mod.3c)
mod <- lm(AVG ~ avg_hit_angle + anglesweetspotpercent,
data = trim )
mod <- lm(AVG ~ avg_hit_angle + anglesweetspotpercent,
data = trim )
#layout(matrix(1:4, 2, 2))
#par(mfrow=c(2,2))
pdf(file = "plot2.pdf", width = 8, height = 6)
plot(mod)
step(mod)
vif(mod)
attr <- sort(c("AVG", "avg_hit_angle", "anglesweetspotpercent", "avg_hit_speed", "SO", "p_longhit", "SF_1000", "AB"))
df <- trim[, attr] %>%
as.matrix() %>%
rcorr(type = "spearman") %>%
tidy()
dummy <- data.frame(column1 = attr,
column2 = attr,
estimate = NA,
p.value = NA)
df2 <- df %>%
dplyr::select(-n) %>%
bind_rows(dummy)
attr_labels <- c("Strikeout", "Sacrifice Fly", "% Long Hit", "Average Exit Velocity", "Average Hit Angle", "Batting Average", "% Sweet Spot", "At-bat")
p <- df2 %>%
ggplot(aes(x = column1,
y = column2)) +
geom_tile(aes(fill = estimate)) +
theme_minimal() +
geom_text(aes(label = round(estimate, digits = 2), family = "mono")) +
theme(axis.title = element_blank(),
panel.background = element_blank(),
axis.text = element_text(size = 10,
colour = "#432818",
family = "mono"),
axis.text.x = element_text(angle = 40, hjust=1),
legend.position = "right",
legend.text = element_text(family = "mono"),
axis.ticks = element_blank()) +
scale_fill_gradient2(low = "#fd9e02",
mid = "white",
high = muted("#75b6c6"),
midpoint = 0,
space = "Lab",
na.value = "transparent",
guide = "colourbar",
aesthetics = "fill",
limits=c(-0.5, 0.5),
name = "") +
scale_x_discrete(labels = attr_labels) +
scale_y_discrete(labels = attr_labels)
library(scales)
mod.1c <- lm(AVG ~ avg_hit_angle + anglesweetspotpercent + avg_hit_speed, trim)
mod.1b <- lm(AVG ~ avg_hit_angle + anglesweetspotpercent , trim)
mod.1a <- lm(AVG ~ avg_hit_angle, trim)
anova(mod.1a, mod.1b, mod.1c)
mod.2c <- lm(AVG ~ avg_hit_speed + avg_hit_angle + anglesweetspotpercent, trim)
mod.2b <- lm(AVG ~ avg_hit_speed + avg_hit_angle , trim)
mod.2a <- lm(AVG ~ avg_hit_speed, trim)
anova(mod.2a, mod.2b, mod.2c)
mod.3c <- lm(AVG ~ anglesweetspotpercent + avg_hit_speed + avg_hit_angle, trim)
mod.3b <- lm(AVG ~ anglesweetspotpercent + avg_hit_speed , trim)
mod.3a <- lm(AVG ~ anglesweetspotpercent, trim)
anova(mod.3a, mod.3b, mod.3c)
mod <- lm(AVG ~ avg_hit_angle + anglesweetspotpercent,
data = trim )
mod <- lm(AVG ~ avg_hit_angle + anglesweetspotpercent,
data = trim )
#layout(matrix(1:4, 2, 2))
#par(mfrow=c(2,2))
pdf(file = "plot2.pdf", width = 8, height = 6)
plot(mod)
step(mod)
vif(mod)
attr <- sort(c("AVG", "avg_hit_angle", "anglesweetspotpercent", "avg_hit_speed", "SO", "p_longhit", "SF_1000", "AB"))
df <- trim[, attr] %>%
as.matrix() %>%
rcorr(type = "spearman") %>%
tidy()
dummy <- data.frame(column1 = attr,
column2 = attr,
estimate = NA,
p.value = NA)
df2 <- df %>%
dplyr::select(-n) %>%
bind_rows(dummy)
attr_labels <- c("Strikeout", "Sacrifice Fly", "% Long Hit", "Average Exit Velocity", "Average Hit Angle", "Batting Average", "% Sweet Spot", "At-bat")
p <- df2 %>%
ggplot(aes(x = column1,
y = column2)) +
geom_tile(aes(fill = estimate)) +
theme_minimal() +
geom_text(aes(label = round(estimate, digits = 2), family = "mono")) +
theme(axis.title = element_blank(),
panel.background = element_blank(),
axis.text = element_text(size = 10,
colour = "#432818",
family = "mono"),
axis.text.x = element_text(angle = 40, hjust=1),
legend.position = "right",
legend.text = element_text(family = "mono"),
axis.ticks = element_blank()) +
scale_fill_gradient2(low = "#fd9e02",
mid = "white",
high = muted("#75b6c6"),
midpoint = 0,
space = "Lab",
na.value = "transparent",
guide = "colourbar",
aesthetics = "fill",
limits=c(-0.5, 0.5),
name = "") +
scale_x_discrete(labels = attr_labels) +
scale_y_discrete(labels = attr_labels)
p
ggsave(filename = "plot2.pdf", device = "pdf",
width = 20, height = 12, units = "cm")
library(patchwork)
mlb <- ((p1/p)) + plot_annotation(tag_levels = "A") + plot_layout(nrow = 2)
ggsave("mlb2.pdf", mlb, device = "pdf")
mlb <- ((p1/p)) + plot_layout(nrow = 2)
ggsave("mlb2.pdf", mlb, device = "pdf")
x = c(6, 8, 10, 12, 14)
y = c(170684,
35369,
13272,
5265,
2838)
plot(x, y)
# simulate the tree
num_tips = 250
tree = ladderize(tess.sim.taxa(1, num_tips, 10, 1, 0.5)[[1]])
install.packages("tidymodels")
install.packages("tidymodels")
install.packages("tidymodels")
install.packages("tidymodels")
install.packages("tidymodels")
install.packages("tidymodels")
install.packages("lme4")
?tess.sim.taxa
library(TESS)
?tess.sim.taxa
setwd("Desktop/ASSIM/lab_hoehna/statedependentOU/")
library(TESS)
library(phytools)
source("scripts/readWriteCharacterData.R")
cat("simulating discrete characters.\n")
# simulation parameters
num_tips   = 500
#num_states = c(1, 2, 4)
num_traits = 4
reps       = 1
grid = expand.grid(num_tips=num_tips, tree=1:reps,
traits=1:num_traits, stringsAsFactors=FALSE)
# simulation parameters
num_tips   = 500
exp_change = c(5, 10, 20)
num_traits = 4
grid = expand.grid(num_tips=num_tips, exp_change=exp_change,
traits=1:num_traits, stringsAsFactors=FALSE)
grid
library(TESS)
library(phytools)
source("scripts/readWriteCharacterData.R")
cat("simulating discrete characters.\n")
# simulation parameters
exp_change = c(5, 10, 20)
num_traits = 4
grid = expand.grid(exp_change=exp_change,
traits=1:num_traits, stringsAsFactors=FALSE)
# first, we need to compute the tree length
this_dir = paste0("data/simulation_3_sameTree_diffRate/n500/t1")
tree <- read.tree(this_dir, "/tree.tre")
tree_length = sum(tree$edge.length)
tree <- read.tree(this_dir, "/tree.tre")
read.tree(this_dir, "/tree.tre")
this_dir
setwd(this_dir)
read.tree("tree.tre")
setwd("../../../..")
# first, we need to compute the tree length
this_dir = paste0("data/simulation_3_sameTree_diffRate/n500/t1")
tree <- read.tree(this_dir, "tree.tre")
tree <- read.tree(paste0(this_dir, "/tree.tre"))
tree_length = sum(tree$edge.length)
# specify the Mk2 rate matrix
Q = matrix(1, 2, 2)
diag(Q) = -1
rownames(Q) = colnames(Q) = 1:2 - 1
# simulate the discrete characters
# track the number of rejected simulations based on proportional
# representation
colors = c("0"="blue","1"="red")
num_rejections = numeric(length(num_tips))
num_simulations = numeric(length(num_tips))
num_simulations = numeric(length(num_tips))
names(num_rejections) = names(num_simulations) = num_tips
bar = txtProgressBar(style=3, width=40)
for(i in 1:nrow(grid)) {
this_row        = grid[i,]
this_exp_change = this_row[[1]]
this_num_traits = this_row[[2]]
# read the tree
this_dir = paste0("data/simulation_3_sameTree_diffRate/n500/t1")
tree = read.tree(paste0(this_dir, "/tree.tre"))
# get the rate
# specify rates so that the expected number of changes is 10
this_rate = this_exp_change / tree_length
# simulate the character
history = sim.history(tree, this_rate * Q, nsim=1, message=FALSE)
# make sure at least 20% of the tips are in either state
while (! (mean(history$states == "0") > 0.2 & (mean(history$states == "1") > 0.2) ) ) {
history = sim.history(tree, this_rate * Q, nsim=1, message=FALSE)
num_rejections[as.character(500)] = num_rejections[as.character(500)] + 1
}
num_simulations[as.character(500)] = num_simulations[as.character(500)] + 1
# make state-0 and state-1 trees
# the branch length of state-i trees is the proportional
# amount of time each branch spends in state i
maps = history$mapped.edge[,c("0","1")]
state_0_tree = tree
state_0_tree$edge.length = maps[,1] / tree$edge.length
state_1_tree = tree
state_1_tree$edge.length = maps[,2] / tree$edge.length
# save these trees
this_sub_dir = paste0("data/simulation_3_sameTree_diffRate/n500/t1", "/r",this_exp_change, "/d", this_num_traits)
if ( !dir.exists(this_sub_dir) ) {
dir.create(this_sub_dir, recursive=TRUE, showWarnings=FALSE)
}
write.tree(state_0_tree, file=paste0(this_sub_dir, "/n500t1r", this_exp_change, "d", this_num_traits, "_State0.tre"))
write.tree(state_1_tree, file=paste0(this_sub_dir, "/n500t1r", this_exp_change, "d", this_num_traits, "_State1.tre"))
# save the discrete trait as a nexus file
writeCharacterData(t(t(history$states)), file=paste0(this_sub_dir, "/n500t1r", this_exp_change, "d", this_num_traits, "_Discrete.nex"), type="Standard")
# save the character history
save(history, file=paste0(this_sub_dir, "/n500t1r", this_exp_change, "d", this_num_traits, "_History.Rda"))
# write a pdf
pdf(paste0(this_sub_dir, "/n500t1r", this_exp_change, "d", this_num_traits, "_History.pdf"))
plot(history, col=colors)
dev.off()
# increment the progress bar
setTxtProgressBar(bar, i / nrow(grid))
}
library(ape)
library(phytools)
library(geiger)
library(TESS)
treeheight <- function(tree) max(node.depth.edgelength(tree))
obtainContinuousStates_ver7 = function(tree, halflife_0, halflife_1,
theta_0, theta_1, stationaryvar_0,
stationaryvar_1, initialValue = theta_0,
dt) {
if (missing(dt)){
dt <- 0.002 * treeheight(history)
}
## Re-parameterization
alpha_0 <- log(2) / halflife_0
alpha_1 <- log(2) / halflife_1
sigma_0 <- sqrt(stationaryvar_0 * 2 * alpha_0)
sigma_1 <- sqrt(stationaryvar_1 * 2 * alpha_1)
cont_states <- list()
preorder <- rev(postorder(tree))
edges <- tree$edge
ntips <- length(tree$tip.label)
root_node <- ntips + 1
node_values <- list()
node_values[[root_node]] <- initialValue
#for (i in 1:length(branch_order)) {
for (edge_index in preorder){
sub_edges <- tree$maps[[edge_index]]
parent_node <- edges[edge_index, 1]
xt0 <- node_values[[parent_node]]
for (j in 1:length(sub_edges)) {
dt_length = sub_edges[j] %/% dt
dt_remainder = sub_edges[j] %% dt
if (as.integer(names(sub_edges[j])) == 0) {
for (k in 1:dt_length) {
xt1 <- xt0 + alpha_0 * (theta_0 - xt0) * dt + sigma_0 * sqrt(dt) * rnorm(1)
xt0 <- xt1
}
xt1 <- xt0 + alpha_0 * (theta_0 - xt0) * dt_remainder + sigma_0 * sqrt(dt_remainder) * rnorm(1)
xt0 <- xt1
}
else {
for (k in 1:dt_length) {
xt1 <- xt0 + alpha_1 * (theta_1 - xt0) * dt + sigma_1 * sqrt(dt) * rnorm(1)
xt0 <- xt1
}
xt1 <- xt0 + alpha_1 * (theta_1 - xt0) * dt_remainder + sigma_1 * sqrt(dt_remainder) * rnorm(1)
xt0 <- xt1
}
}
desc_node <- edges[edge_index, 2]
node_values[[desc_node]] <- xt0
}
disc_states <- list()
for (i in 1:length(edges[,2])) {
is_tip <- !(edges[i,2] %in% edges[,1])
if (is_tip) {
tip_label <- tips(tree, edges[i,2])
cont_states[[tip_label]] <- unname(node_values[[edges[i,2]]])
disc_states[[tip_label]] <- tail(names(history$maps[[i]]), n = 1)
}
}
res <- list(
cont_states,
disc_states
)
return(res)
}
cat("simulating continuous characters.\n")
num_tips   = 500
exp_change = c(5, 10, 20)
num_dtraits = 4
num_ctraits = 4
grid = expand.grid(exp_change = exp_change,
dtraits=1:num_dtraits, ctraits=1:num_ctraits,
stringsAsFactors=FALSE)
bar = txtProgressBar(style=3, width=40)
for(i in 1:nrow(grid)) {
this_row          = grid[i,]
this_exp_change  = this_row[[1]]
this_num_dtraits = this_row[[2]]
this_num_ctraits = this_row[[3]]
# read the history
this_dir = paste0("data/n500/t1/r",this_exp_change, "/d", this_num_dtraits)
load(paste0(this_dir, "/n500t1r", this_exp_change,
"d", this_num_dtraits, "_History.Rda"))
cont_states_ver7 <- obtainContinuousStates_ver7(tree = history,
halflife_0 = 0.35, halflife_1 = 0.35,
theta_0 = 0.5, theta_1 = 2,
stationaryvar_0 = 0.0625, stationaryvar_1 = 0.0625,
initialValue = 0.5, dt = 0.001)
#log_cont_states <- list()
#for (i in 1:length(cont_states_ver7[[1]])) {
#  tiplabel <- names(cont_states_ver7[[1]][i])
#  log_value <- log(as.double(cont_states_ver7[[1]][i]))
#  log_cont_states[[tiplabel]] <- log_value
#}
write.nexus.data(cont_states_ver7[[1]],
file = paste0(this_dir, "/n500t1r", this_exp_change,
"d", this_num_dtraits,
"c", this_num_ctraits, "_Continuous.nex"),
format="Continuous")
#write.nexus.data(log_cont_states,
#                 file = paste0(this_dir, "/n", this_num_tips,
#                               "t", this_tree, "_logContinuous.nex"),
#                 format="Continuous")
setTxtProgressBar(bar, i / nrow(grid))
}
for(i in 1:nrow(grid)) {
this_row          = grid[i,]
this_exp_change  = this_row[[1]]
this_num_dtraits = this_row[[2]]
this_num_ctraits = this_row[[3]]
# read the history
this_dir = paste0("data/simulation_3_sameTree_diffRate/n500/t1/r",this_exp_change, "/d", this_num_dtraits)
load(paste0(this_dir, "/n500t1r", this_exp_change,
"d", this_num_dtraits, "_History.Rda"))
cont_states_ver7 <- obtainContinuousStates_ver7(tree = history,
halflife_0 = 0.35, halflife_1 = 0.35,
theta_0 = 0.5, theta_1 = 2,
stationaryvar_0 = 0.0625, stationaryvar_1 = 0.0625,
initialValue = 0.5, dt = 0.001)
#log_cont_states <- list()
#for (i in 1:length(cont_states_ver7[[1]])) {
#  tiplabel <- names(cont_states_ver7[[1]][i])
#  log_value <- log(as.double(cont_states_ver7[[1]][i]))
#  log_cont_states[[tiplabel]] <- log_value
#}
write.nexus.data(cont_states_ver7[[1]],
file = paste0(this_dir, "/n500t1r", this_exp_change,
"d", this_num_dtraits,
"c", this_num_ctraits, "_Continuous.nex"),
format="Continuous")
#write.nexus.data(log_cont_states,
#                 file = paste0(this_dir, "/n", this_num_tips,
#                               "t", this_tree, "_logContinuous.nex"),
#                 format="Continuous")
setTxtProgressBar(bar, i / nrow(grid))
}
rnorm(500, 0.247552565, 0.587)
plot(rnorm(500, 0.247552565, 0.587))
distribution <- rnorm(500, 0.247552565, 0.587)
hist(distribution)
hist(distribution)
hist(distribution, breaks = 100)
distribution <- rnorm(500, 0.247552565, 0.587)
hist(distribution, breaks = 100)
distribution <- rnorm(500, 0.04375, 0.587)
hist(distribution, breaks = 100)
distribution <- rnorm(500, 0.04375, 0.587)
hist(distribution, breaks = 100)
0.247552565
0.247552565
distribution <- rnorm(500, 0.247552565, 0.587)
hist(distribution, breaks = 100)
median(distribution)
distribution <- rnorm(500, 0.04375, 0.587)
hist(distribution, breaks = 100)
median(distribution)
halflife_0 = 0.35
stationaryvar_0 = 0.0625
alpha_0 <- log(2) / halflife_0
sigma_0 <- sqrt(stationaryvar_0 * 2 * alpha_0)
sigma2 <- stationaryvar_0 * 2 * alpha_0
sigma2
cat("writing Rev scripts for simulation 1.\n")
# settings
num_tips   = 500
exp_change = c(5, 10, 20)
num_dtraits = 4
num_ctraits = 4
dir.create("jobs", showWarnings=FALSE)
grid = expand.grid(exp_change = exp_change, dtrait=1:num_dtraits,
ctrait=1:num_ctraits, stringsAsFactors=FALSE)
# read the stub
lines = readLines("scripts/mcmc_sdOU_simulation_template.Rev")
# make all the job scripts
bar = txtProgressBar(style=3, width=40)
for(i in 1:nrow(grid)) {
this_row         = grid[i,]
this_exp_change  = this_row[[1]]
this_num_dtraits = this_row[[2]]
this_num_ctraits = this_row[[3]]
this_disc_file = paste0('/n500t1r', this_exp_change,
'd', this_num_dtraits,
'_Discrete.nex")')
this_cont_file = paste0('/n500t1r', this_exp_change,
'd', this_num_dtraits,
'c', this_num_ctraits)
these_lines = lines
these_lines[20]  = paste0('tree <- readTrees("data/simulation_3_sameTree_diffRate/n500/t1/tree.tre")[1]')
these_lines[25]  = paste0('cont <- readContinuousCharacterData("data/simulation_3_sameTree_diffRate/n500/t1/r',
this_exp_change, '/d', this_num_dtraits, this_cont_file, '_Continuous.nex")')
these_lines[30] = paste0('disc <- readDiscreteCharacterData("data/simulation_3_sameTree_diffRate/n500/t1/r',
this_exp_change, '/d', this_num_dtraits, this_disc_file)
these_lines[112] = paste0('monitors.append( mnModel(filename="output/sdOU_simulation3_n500t1r',
this_exp_change, 'd', this_num_dtraits,
'c', this_num_ctraits, '.log", printgen=10) )')
this_file = paste0('jobs/sim3_n500t1r', this_exp_change,
'd', this_num_dtraits,
'c', this_num_ctraits,'.Rev')
cat(these_lines, file = this_file, sep="\n")
setTxtProgressBar(bar, i / nrow(grid))
}
cat("writing Rev scripts for simulation 1.\n")
# settings
num_tips   = c(100, 250, 500)
num_dtraits = 4
num_ctraits = 4
reps       = 1
dir.create("jobs", showWarnings=FALSE)
grid = expand.grid(num_tips=num_tips, tree=1:reps, dtrait=1:num_dtraits,
ctrait=1:num_ctraits, stringsAsFactors=FALSE)
# read the stub
lines = readLines("scripts/mcmc_sdOU_simulation_template.Rev")
# make all the job scripts
bar = txtProgressBar(style=3, width=40)
for(i in 1:nrow(grid)) {
this_row = grid[i,]
this_num_tips    = this_row[[1]]
this_tree        = this_row[[2]]
this_num_dtraits = this_row[[3]]
this_num_ctraits = this_row[[4]]
this_disc_file = paste0('/n', this_num_tips,
't', this_tree, 'd', this_num_dtraits,
'_Discrete.nex")')
this_cont_file = paste0('/n', this_num_tips,
't', this_tree, 'd', this_num_dtraits,
'c', this_num_ctraits)
these_lines = lines
these_lines[20]  = paste0('tree <- readTrees("data/simulation_2_sameRate_diffTree/n', this_num_tips, '/t', this_tree, '/tree.tre")[1]')
these_lines[25]  = paste0('cont <- readContinuousCharacterData("data/simulation_2_sameRate_diffTree/n', this_num_tips,
'/t', this_tree, '/d', this_num_dtraits, this_cont_file, '_Continuous.nex")')
these_lines[30] = paste0('disc <- readDiscreteCharacterData("data/simulation_2_sameRate_diffTree/n', this_num_tips,
'/t', this_tree, '/d', this_num_dtraits, this_disc_file)
these_lines[112] = paste0('monitors.append( mnModel(filename="output/sdOU_simulation2_n',
this_num_tips, 't', this_tree, 'd', this_num_dtraits,
'c', this_num_ctraits, '.log", printgen=10) )')
this_file = paste0('jobs/sim2_n', this_num_tips,
't', this_tree, 'd', this_num_dtraits,
'c', this_num_ctraits,'.Rev')
cat(these_lines, file = this_file, sep="\n")
setTxtProgressBar(bar, i / nrow(grid))
}
